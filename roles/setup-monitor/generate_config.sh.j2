#!/bin/bash

CONFIG=/etc/prometheus/prometheus.yml

before_sum=$(sha256sum $CONFIG)

echo $before_sum

# clear file

truncate -s 0 $CONFIG

# append first block

cat /root/bin/config_piece_1 >> $CONFIG

# append host list

echo "      - 'matrix.perthchat.org:9100'" >> $CONFIG
curl --silent --user admin:{{ admin_password }} https://{{ awx_url }}/api/v2/hosts/ |
	jq .results[].name |
	sort -u |
	tr -d '"\\' |
	egrep -v "dummyvalue|example\.com" |
        while read line; do echo "      - '$line:9100'"; done >> $CONFIG

# append second block

cat /root/bin/config_piece_2 >> $CONFIG

# append host list

echo "      - 'matrix.perthchat.org:9000'" >> $CONFIG
curl --silent --user admin:{{ admin_password }} https://{{ awx_url }}/api/v2/hosts/ |
        jq .results[].name |
        sort -u |
        tr -d '"\\' |
        egrep -v "dummyvalue|example\.com" |
        while read line; do echo "      - '$line:9000'"; done >> $CONFIG

after_sum=$(sha256sum $CONFIG)

echo $after_sum

if [ "$before_sum" != "$after_sum" ]; then
    echo "Checksums are not equal"
    systemctl restart prometheus
else
    echo "Checksums are equal"
fi


